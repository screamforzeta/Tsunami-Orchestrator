# Tsunami Security Scanner Orchestrator Documentation

Per leggere la versione italiana di questa documentazione, clicca [qui](./README.it.md)

## Introduction

The **Tsunami Security Scanner Orchestrator** is a tool designed to automate network and IP address scanning using Google's **Tsunami Security Scanner**. The tool allows you to:

* Scan individual IP addresses, subnets, or lists of addresses/subnets.
* Launch Docker containers to perform the scans.
* Analyze scan results through a log parsing module.

The program is divided into two main components:

1. **Orchestrator**: Coordinates scans and manages Docker container execution.
2. **Log Parser**: Analyzes scan results and generates detailed reports.

**Note**: The correct functioning of this program is based on the execution of the **Tsunami Security Scanner** tool. More information is available in the [official project repository](https://github.com/google/tsunami-security-scanner). During the analysis of some host or service types, the container execution time may be extended (some tests recorded up to 10 minutes). In these cases, do not interrupt the program, as this may be a normal extended processing phase. All potential errors generated by the scanner are handled by the program.

---

## Main Components

### 1. **Orchestrator**

The orchestrator is the system's core and is responsible for:

* Validating provided IP addresses.
* Identifying active hosts using `nmap`.
* Launching Docker containers to perform scans.
* Coordinating the entire scanning and parsing process.

#### Key Files:

* `orchestrator.py`: Main function managing the scans.
* `orch_library.py`: Library containing all functions used by the orchestrator.

#### Main Functions:

* `parse_arguments`: Parses command-line arguments.
* `validate_ip` and `validate_subnet`: Validate the correctness of IP addresses or CIDR-formatted subnets.
* `is_ip_active`: Checks if an IP is active using `nmap`.
* `remove_duplicates_from_file`: Removes duplicate lines from a file, preserving the original order.
* `get_positive_integer_input`: Requests a positive numeric input from the user.
* `clear_directories`: Clears previously used output directories.
* `scan_single_ip`, `scan_ip_list_manager`, `scan_subnet_and_save_results`, `scan_multiple_subnets_manager`: Manage the initiation of scans in various supported scenarios.
* `start_docker_containers`: Starts Docker containers for a list of IP addresses, with a maximum of \[max\_containers] running concurrently.

---

### 2. **Log Parser**

The log parser analyzes scan results and generates detailed reports in Excel format.

#### Key Files:

* `log_parser.py`: Contains log analysis functions.
* `classes.py`: Contains classes used by the log parser to store data obtained from Tsunami Security Scanner.

#### Main Functions:

* `process_all_json_in_directory(input_directory, output_folder)`
* `process_json_based_on_vulnerability(json_path, output_folder)`
* `no_vuln_process`
* `found_vuln_process`
* `process_network_endpoint`, `process_network_services`, `process_no_network_services`
* `append_to_excel`, `append_vuln`
* `adjust_excel_column_width`

---

### 3. **Tsunami Security Scanner**

The Tsunami Security Scanner tool is integrated into the project to perform security scans. It is configured via Docker and uses plugins to detect vulnerabilities.

---

## Main Features

### 1. **Network and IP Address Scanning**

The orchestrator supports various types of scans:

* Single IP address
* List of IP addresses
* Single subnet (CIDR format, e.g., `192.168.1.0/24`)
* List of subnets

Scans use `nmap` to identify active hosts and launch Docker containers for scanning.

### 2. **Docker Container Management**

For each identified active host, a Docker container is launched to execute the **Tsunami Security Scanner**. Results are saved in JSON format in the `/Tsunami_Outputs` directory.

---

## Usage Instructions

### 1. **Preparation**

#### Installing Dependencies

To view all the dependencies required by this program, refer to the dedicated section at the end of the file, or [click here](#dependencies).

* Clone the repository:

```bash
git clone --recurse-submodules https://github.com/screamforzeta/Tsunami-Orchestrator.git
```

* Install Docker:

  * Docker Desktop: [https://docs.docker.com/desktop/](https://docs.docker.com/desktop/)
  * Docker Engine: [https://docs.docker.com/engine/](https://docs.docker.com/engine/)

* Build Docker images:

```bash
docker build -t tsunami:latest ./tsunami-security-scanner
docker build -t orch:latest .
```

**Note:** In some situations, during the Docker image build process, you may encounter errors such as: 
```bash
E: Unable to locate package nmap
E: Unable to locate package ncrack
```
If this happens, it is recommended to repeat the build command by adding the `--network=host` option as follows:
```bash
docker build --network=host -t tsunami:latest ./tsunami-security-scanner
docker build --network=host -t orch:latest .
```

### 2. **Running the Program**

**Note**: Run commands from the main repository directory (Tsunami-Orchestrator/).

* **Interactive Mode**:

```bash
sudo docker run -it --network="network_name" \
 --rm \
 -v $(pwd)/Parsed_report:/usr/Orchestrator/Parsed_report \
 -v $(pwd)/Tsunami_outputs:/usr/Orchestrator/logs \
 -v $(pwd)/input_files:/usr/Orchestrator/input_files \
 orch:latest
```

* **With Specific Arguments**:

```bash
sudo docker run -it --network="network_name" \
 --rm \
 -v $(pwd)/Parsed_report:/usr/Orchestrator/Parsed_report \
 -v $(pwd)/Tsunami_outputs:/usr/Orchestrator/logs \
 -v $(pwd)/input_files:/usr/Orchestrator/input_files \
 orch:latest [args] [val]
```

* **Help Options**:

```bash
sudo docker run -it --network="network_name" \
 --rm \
 -v $(pwd)/Parsed_report:/usr/Orchestrator/Parsed_report \
 -v $(pwd)/Tsunami_outputs:/usr/Orchestrator/logs \
 -v $(pwd)/input_files:/usr/Orchestrator/input_files \
 orch:latest -h
```

* **Launching the GUI**:
  To use the GUI, activate a Python virtual environment (`python3 -m venv`) and install the required dependencies listed in `requirements.txt`. For details, refer to the [official venv documentation](https://docs.python.org/3/library/venv.html).

Then run:

```bash
sudo /path/to/venv/bin/python src/GUI/orchestrator_GUI.py
```

### Docker Volumes Explanation
When running the program via Docker, it is possible (and recommended) to mount certain directories from the local system as volumes inside the container. Each volume serves a specific purpose:

   * Parsed_Report: Directory where the final results of the execution will be saved, specifically the Excel file containing all relevant information collected during the scan.
   * Tsunami_Outputs (optional): Directory that will contain the raw JSON files generated by the Tsunami Security Scanner. This is useful for preserving the original scan results, but the program will work correctly even if this volume is not mounted.
   * Input_Files: Directory where the user can place input files required for certain execution modes (for example, scans on lists of IPs or subnets). Mounting this volume is not always mandatory, but it is required in cases where input files are necessary for the correct execution of the program.

   
### 3. **Testing**

#### Testing Vulnerable Environments

The `Vulnerable_env/` directory contains test environments configured with `docker compose`.
Some images are taken from the [VulHub repository](https://github.com/vulhub/vulhub); these need to be built locally, but to do so simply run `./build_images.sh` in `Vuln_env/` to download the necessary data. After that, run the command `docker compose up` to start the entire environment.

**N.B.**: For convenience, I created an external network called **Vuln_net** within the compose file, with the address **192.168.147.0**; this is because it is an address that is rarely used and therefore should not interfere with existing local networks. In case such issues do arise, simply modify the address in the `docker-compose.yaml` file

**Some Docker Compose setups are built locally and do not work on Linux Arm64 architectures.**

To scan the vulnerable network:

```bash
sudo docker run -it --network="vuln_net" \
 --rm \
 -v $(pwd)/Parsed_report:/usr/Orchestrator/Parsed_report \
 -v $(pwd)/Tsunami_outputs:/usr/Orchestrator/logs \
 -v $(pwd)/input_files:/usr/Orchestrator/input_files \
 orch:latest -sub 192.168.147.0/24
```

To forcefully stop all containers:

```bash
docker stop $(docker ps -q)
```

#### Testing the Log Parser

Run `log_parser.py` on a directory with JSON scan files.

---

## Execution Flow

1. **Preparation**:

   * Output directories are cleaned.
   * Input is gathered from CLI or interactively.

2. **Scanning**:

   * Scans are executed based on user input.
   * Docker containers are launched for active hosts.

3. **Log Parsing**:

   * The `log_parser` module analyzes generated JSON files.

4. **Output**:

   * Results are saved as JSON and Excel files.

---

## Requirements

### Dependencies

#### System Tools

* **Python 3.x**
  * `python3-pip`
  * `python3-venv`
  * `python3-tk`
* **nmap**
* **ncrack**
* **Docker**

#### Python Modules

Install using:

```bash
pip install -r requirements.txt
```

* numpy
* openpyxl
* rich
* customtkinter

---

## Repository Structure

### Main Directories

* `Tsunami-Orchestrator/`
* `src/`
* `input_files/`
* `Parsed_report/`
* `Tsunami_outputs/`
* `Vulnerable_env/`
* `tsunami-security-scanner/`
